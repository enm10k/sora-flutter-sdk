name: test

on:
  push:
    paths-ignore:
      - '.github/workflows/build.yaml'
      - '**.md'
      - 'example'
      - '.fvm'

jobs:
  test-ios:
    strategy:
      matrix:
        name:
          - ios
    name: Test on iOS
    runs-on: macos-12
    env:
      XCODE: /Applications/Xcode_14.0.1.app
      SIGNALING_URLS: ${{ secrets.TEST_SIGNALING_URLS }}
      CHANNEL_ID: ${{ secrets.TEST_CHANNEL_ID }}
      METADATA: ${{ secrets.TEST_METADATA }}
    steps:
      - name: Add Masked Secrets
        run: |
          echo "::add-mask::$SIGNALING_URLS"
          echo "::add-mask::$CHANNEL_ID"
          echo "::add-mask::$METADATA"
      - name: Create Test Channel ID
        run: |
          uuidgen > USER.txt
          echo "::add-mask::" > USER_MASK.txt
          cat USER.txt > USER_MASK.txt
          cat USER_MASK.txt
          cat USER.txt > CHANNEL_ID.txt
          echo "@$CHANNEL_ID" > CHANNEL_ID.txt
          echo "::add-mask::" > CHANNEL_ID_MASK.txt
          cat CHANNEL_ID.txt > CHANNEL_ID_MASK.txt
          cat CHANNEL_ID_MASK.txt
          echo "CHANNEL_ID=`cat CHANNEL_ID.txt`" >> $GITHUB_ENV
          rm USER.txt USER_MASK.txt CHANNEL_ID.txt CHANNEL_ID_MASK.txt
      - uses: actions/checkout@v3
      - name: Select Xcode Version
        run: sudo xcode-select -s '${{ env.XCODE }}/Contents/Developer'
      - name: Show Xcode Version
        run: xcodebuild -version
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          architecture: x64
      - name: Show Flutter Available Emulators
        run: flutter emulators
      - name: Launch iOS Simulator
        run: flutter emulators --launch apple_ios_simulator
      - name: Show Flutter Available Devices
        run: flutter devices
      - name: Generate Configuration
        working-directory: ./integration_test_app
        run: ../scripts/create_env.sh lib/environment.dart $SIGNALING_URLS ${{ env.CHANNEL_ID }} $METADATA
      - name: Get Flutter Dependencies
        working-directory: ./integration_test_app 
        run: flutter pub get
      - name: Run Integration Tests
        working-directory: ./integration_test_app
        run: flutter test integration_test/connect_test.dart -d iPhone